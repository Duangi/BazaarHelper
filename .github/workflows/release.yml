name: "Release"

on:
  push:
    tags:
      - 'v*' # 触发条件：推送 v0.4.7 这种标签

jobs:
  publish:
    permissions:
      contents: write
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # --- 缓存优化 ---
      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable

      # 1. 【核心策略】同步版本号并“临时拆除”更新配置
      - name: Prepare Config
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          
          # 更新 package.json
          $pkg = Get-Content package.json | ConvertFrom-Json
          $pkg.version = $version
          $pkg | ConvertTo-Json | Out-File package.json -Encoding utf8

          # 更新 tauri.conf.json 
          $conf = Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json
          $conf.version = $version
          
          # 【关键】暂时移除整个 updater 插件配置
          # 这样 tauri-action 就不会去寻找私钥，也就绝对不会报错
          $conf.plugins.PSObject.Properties.Remove('updater')
          
          $conf | ConvertTo-Json -Depth 10 | Out-File src-tauri/tauri.conf.json -Encoding utf8
          echo "✅ 配置文件已暂时移除 updater 插件，避开官方构建 Bug"

      - name: install frontend dependencies
        run: npm install

      # 2. 运行构建 (此时因为没有配置 updater，它会 100% 构建成功)
      - uses: tauri-apps/tauri-action@v0
        id: tauri_build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v__VERSION__
          releaseName: "Bazaar Helper v__VERSION__"
          releaseDraft: true
          prerelease: false

      # 3. 【暴力补救】构建完成后，手动执行签名逻辑
      - name: Force Sign and Update JSON
        shell: pwsh
        run: |
          $version = "${{ steps.tauri_build.outputs.appVersion }}"
          $bundlePath = "src-tauri/target/release/bundle/nsis"
          
          # 1. 定位安装包
          $exeFile = Get-ChildItem -Path "$bundlePath/*.exe" -Recurse | Where-Object { $_.Name -like "*setup.exe" } | Select-Object -First 1
          if ($null -eq $exeFile) { Write-Error "未找到安装包"; exit 1 }
          echo "目标安装包: $($exeFile.FullName)"

          # 2. 还原私钥文件 (使用二进制还原法，最稳)
          $tempKeyPath = "src-tauri/temp.key"
          $base64Secret = "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}"
          $rawKeyBytes = [System.Convert]::FromBase64String($base64Secret)
          [System.IO.File]::WriteAllBytes($tempKeyPath, $rawKeyBytes)

          # 3. 显式调用签名工具补齐 .sig 文件
          $env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD = "${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}"
          npx tauri signer sign "$($exeFile.FullName)" --private-key-path "$tempKeyPath"
          
          $sigFile = "$($exeFile.FullName).sig"
          if (!(Test-Path $sigFile)) { Write-Error "签名补全失败"; exit 1 }
          
          $signature = Get-Content -Path $sigFile
          echo "✅ 手动签名补全成功"

          # 4. 构造 update.json
          $updateData = @{
              version = $version
              notes = "Bazaar Helper v$version 正式发布"
              pub_date = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
              platforms = @{
                  "windows-x86_64" = @{
                      signature = $signature
                      url = "https://github.com/${{ github.repository }}/releases/download/v$version/BazaarHelper_$($version)_x64-setup.exe"
                  }
              }
          }
          $updateData | ConvertTo-Json -Depth 10 | Out-File "update.json" -Encoding utf8
          
          # 清理
          Remove-Item $tempKeyPath

      # 4. 推送更新后的 update.json
      - name: Commit and push update.json
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add update.json
          git commit -m "chore: 自动更新版本元数据 [skip ci]"
          git push origin main --force