name: "Release"

on:
  push:
    tags:
      - 'v*' 

jobs:
  publish:
    permissions:
      contents: write # 必须开启写入权限
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: install Rust
        uses: dtolnay/rust-toolchain@stable

      # 自动同步版本号（你本地不需要改，根据 Tag 自动变）
      - name: Sync version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          echo "同步版本号至: $version"
          $pkg = Get-Content package.json | ConvertFrom-Json
          $pkg.version = $version
          $pkg | ConvertTo-Json | Out-File package.json -Encoding utf8
          $conf = Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json
          $conf.version = $version
          $conf | ConvertTo-Json -Depth 10 | Out-File src-tauri/tauri.conf.json -Encoding utf8

      - name: install frontend dependencies
        run: npm install

      # 步骤 1：执行构建
      - uses: tauri-apps/tauri-action@v0
        id: tauri_build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: "Bazaar Helper v__VERSION__"
          releaseDraft: true
          prerelease: false

      # 步骤 2：暴力补签逻辑 (完全复刻你本地成功的命令)
      - name: Force Sign and Update JSON
        shell: pwsh
        run: |
          $version = "${{ steps.tauri_build.outputs.appVersion }}"
          $bundlePath = "src-tauri/target/release/bundle/nsis"
          
          # 1. 找到生成的安装包
          $exeFile = Get-ChildItem -Path "$bundlePath/*.exe" -Recurse | Where-Object { $_.Name -like "*setup.exe" } | Select-Object -First 1
          echo "目标安装包: $($exeFile.FullName)"

          # 2. 检查签名是否存在
          $sigFile = Get-ChildItem -Path "$bundlePath/*.sig" -Recurse | Select-Object -First 1
          if ($null -eq $sigFile) {
            echo "⚠️ 自动签名未生成，正在执行手动补签..."
            
            # --- 核心黑科技：在虚拟机里重建私钥文件 ---
            $tempKeyPath = "src-tauri/temp.key"
            $privateKeyContent = @"
            ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
            "@
            $privateKeyContent | Out-File -FilePath $tempKeyPath -Encoding ascii
            
            # 设置密码环境变量
            $env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD = "${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}"
            
            # 执行你本地测试成功的那个命令
            npx tauri signer sign "$($exeFile.FullName)" --private-key-path "$tempKeyPath"
            
            # 删掉临时文件
            Remove-Item $tempKeyPath
            
            # 重新获取签名文件
            $sigFile = Get-ChildItem -Path "$bundlePath/*.sig" -Recurse | Select-Object -First 1
          }

          if ($null -eq $sigFile) {
            Write-Error "❌ 即使补签也失败了，请确认 Secrets 内容是否完整。"
            exit 1
          }

          # 读取签名内容
          $signature = Get-Content -Path $sigFile.FullName
          echo "✅ 签名抓取成功"

          # 3. 构造新的 update.json
          $updateData = @{
              version = $version
              notes = "Bazaar Helper v$version 自动发布"
              pub_date = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
              platforms = @{
                  "windows-x86_64" = @{
                      signature = $signature
                      url = "https://github.com/${{ github.repository }}/releases/download/v$version/BazaarHelper_$($version)_x64-setup.exe"
                  }
              }
          }
          $updateData | ConvertTo-Json -Depth 10 | Out-File "update.json" -Encoding utf8

      # 步骤 3：把改好的 update.json 推回仓库
      - name: Push update.json
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add update.json
          git commit -m "chore: 自动更新 update.json 版本"
          git push origin main --force