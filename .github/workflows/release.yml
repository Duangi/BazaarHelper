name: "Release"

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    permissions:
      contents: write
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: install Rust
        uses: dtolnay/rust-toolchain@stable

      # 1. 同步版本号
      - name: Sync version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $pkg = Get-Content package.json | ConvertFrom-Json
          $pkg.version = $version
          $pkg | ConvertTo-Json | Out-File package.json -Encoding utf8
          $conf = Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json
          $conf.version = $version
          $conf | ConvertTo-Json -Depth 10 | Out-File src-tauri/tauri.conf.json -Encoding utf8

      # 2. 【核心修复】：在构建开始前，还原物理私钥文件
      - name: Restore Private Key File
        shell: pwsh
        run: |
          # 将 Secret 里的 Base64 还原为真实的 tauri.key 文件
          $base64Secret = "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}"
          $rawKeyBytes = [System.Convert]::FromBase64String($base64Secret)
          $keyPath = "src-tauri/tauri.key"
          [System.IO.File]::WriteAllBytes($keyPath, $rawKeyBytes)
          echo "✅ 私钥物理文件已在构建前还原成功"

      - name: install frontend dependencies
        run: npm install

      # 3. 运行构建（现在它能找到私钥文件了，不会崩溃）
      - uses: tauri-apps/tauri-action@v0
        id: tauri_build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 关键：告诉 Tauri 私钥就在刚才生成的那个文件里
          TAURI_SIGNING_PRIVATE_KEY: "src-tauri/tauri.key"
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: "" # 你的私钥是空密码
        with:
          tagName: v__VERSION__
          releaseName: "Bazaar Helper v__VERSION__"
          releaseDraft: true
          prerelease: false

      # 4. 生成 update.json（现在签名肯定已经自动生成了）
      - name: Update update.json
        shell: pwsh
        run: |
          $version = "${{ steps.tauri_build.outputs.appVersion }}"
          $sigFile = Get-ChildItem -Path "src-tauri/target/release/bundle/nsis/*.sig" -Recurse | Select-Object -First 1
          
          if ($null -eq $sigFile) {
             Write-Error "❌ 签名文件还是没生成，检查 tauri.conf.json 的 plugins.updater.active 是否为 true"
             exit 1
          }

          $signature = Get-Content -Path $sigFile.FullName
          $updateData = @{
              version = $version
              notes = "Bazaar Helper v$version 正式发布"
              pub_date = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
              platforms = @{
                  "windows-x86_64" = @{
                      signature = $signature
                      url = "https://github.com/${{ github.repository }}/releases/download/v$version/BazaarHelper_$($version)_x64-setup.exe"
                  }
              }
          }
          $updateData | ConvertTo-Json -Depth 10 | Out-File "update.json" -Encoding utf8
          # 清理私钥，安全第一
          Remove-Item "src-tauri/tauri.key"

      - name: Commit and push update.json
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add update.json
          git commit -m "chore: 自动更新版本元数据"
          git push origin main --force